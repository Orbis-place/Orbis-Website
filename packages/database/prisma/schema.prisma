generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

enum ServerStatus {
  PENDING // Waiting for admin approval
  APPROVED // Live and visible
  REJECTED // Rejected by admin
  SUSPENDED // Temporarily suspended
  ARCHIVED // Archived by owner
}

enum TeamMemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum TeamInvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
  EXPIRED
}

enum ReportReason {
  SPAM
  REUPLOADED_WORK
  INAPPROPRIATE
  MALICIOUS
  NAME_SQUATTING
  POOR_DESCRIPTION
  INVALID_METADATA
  HARASSMENT
  IMPERSONATION
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ReportResourceType {
  USER
  RESOURCE
  RESOURCE_VERSION
  RESOURCE_COMMENT
  SHOWCASE_POST
  SHOWCASE_POST_COMMENT
  SERVER
}

enum SocialLinkType {
  TWITTER
  GITHUB
  DISCORD
  YOUTUBE
  TWITCH
  LINKEDIN
  INSTAGRAM
  FACEBOOK
  REDDIT
  TIKTOK
  CUSTOM
}

enum DiscoveryResourceCollectionType {
  SELECTION_OF_WEEK // Featured resource of the week
  HIDDEN_GEMS // Lesser-known quality resources
  STARTER_PACK // Essential resources for beginners
  THEME_OF_MONTH // Monthly themed collection
}

// ============================================
// SHOWCASE ENUMS
// ============================================

enum ShowcaseCategory {
  THREE_D_MODEL    // 3D Models, characters, props
  TEXTURE          // Textures, materials
  MAP              // Maps, worlds, terrain
  PLUGIN           // Plugin previews
  CONCEPT_ART      // Concept art, sketches
  ANIMATION        // Animations, VFX
  MUSIC_SOUND      // Music, sound effects
  OTHER            // Other creations
}

enum ShowcasePostStatus {
  DRAFT     // Not visible
  PUBLISHED // Visible to everyone
  ARCHIVED  // Hidden by user
}

enum ShowcaseMediaType {
  IMAGE
  VIDEO
}

enum NotificationType {
  LIKED_PROJECT_UPDATE    // Resource you liked got updated
  NEW_CREATOR_UPLOAD      // Creator you follow uploaded new resource
  NEW_FOLLOWER            // Someone followed you
  VERSION_APPROVED        // Resource version approved
  VERSION_REJECTED        // Resource version rejected
  COLLECTION_ADDITION     // Resource added to collection
  SHOWCASE_LIKE           // Someone liked your showcase post
  SHOWCASE_COMMENT        // Someone commented on showcase post
}

// ============================================
// USER MODEL
// ============================================

model User {
  // Core fields (Better Auth)
  id            String   @id @default(cuid())
  username      String   @unique
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  banned        Boolean  @default(false)
  apikeys       Apikey[]

  // Better Auth relations
  sessions Session[]
  accounts Account[]

  // Profile fields
  displayName String?
  banner      String?
  bio         String? @db.Text
  location    String?
  website     String?

  // Account management
  role      UserRole      @default(USER)
  status    AccountStatus @default(ACTIVE)
  banReason String?       @db.Text
  bannedAt  DateTime?
  bannedBy  String?

  // Community
  reputation Int @default(0)

  // Preferences
  emailNotifications Boolean @default(true)
  marketingEmails    Boolean @default(false)
  showEmail          Boolean @default(false)
  showLocation       Boolean @default(true)
  showOnlineStatus     Boolean @default(true)
  showFollowers        Boolean @default(true)
  showFollowing        Boolean @default(true)
  allowTeamInvitations Boolean @default(true)
  theme                String  @default("dark")
  language           String  @default("en")

  // Notification preferences
  notifLikedProjectUpdates  Boolean @default(true)
  notifNewCreatorUploads    Boolean @default(true)
  notifNewFollowers         Boolean @default(true)
  notifVersionStatus        Boolean @default(true)
  notifCollectionAdditions  Boolean @default(true)
  notifShowcaseInteractions Boolean @default(true)

  // Activity tracking
  lastLoginAt  DateTime?
  lastActiveAt DateTime?

  // Social relations
  following Follow[] @relation("Follower")
  followers Follow[] @relation("Following")

  // Server ownership
  ownedServers    Server[] @relation("ServerOwner")
  approvedServers Server[] @relation("ServerApprover")

  // Team relations
  ownedTeams          Team[]           @relation("TeamOwner")
  teamMemberships     TeamMember[]     @relation("TeamMemberships")
  sentInvitations     TeamInvitation[] @relation("TeamInvitationsSent")
  receivedInvitations TeamInvitation[] @relation("TeamInvitationsReceived")

  // Server status changes
  statusChanges ServerStatusHistory[] @relation("StatusChanger")

  // Reports
  submittedReports Report[] @relation("ReportSubmitter")
  handledReports   Report[] @relation("ReportHandler")
  reportsAgainst   Report[] @relation("ReportedUser")

  // Badges
  userBadges UserBadge[] @relation("UserBadges")

  // Marketplace - Resources
  ownedResources     Resource[] @relation("OwnedResources")
  moderatedResources Resource[] @relation("ModeratedResources")

  // Marketplace - Interactions
  contributions ResourceContributor[]
  likes         ResourceLike[]
  favorites     ResourceFavorite[]
  downloads     ResourceDownload[]

  // Marketplace - Status & Images
  resourceStatusChanges     ResourceStatusHistory[]
  resourceDescriptionImages ResourceDescriptionImage[]      @relation("ResourceDescriptionImages")
  versionChangelogImages    ResourceVersionChangelogImage[] @relation("VersionChangelogImages")

  // Server - Description Images
  serverDescriptionImages ServerDescriptionImage[] @relation("ServerDescriptionImages")

  // Social Links
  socialLinks UserSocialLink[] @relation("UserSocialLinks")

  // Showcase
  showcasePosts        ShowcasePost[]        @relation("ShowcasePosts")
  ownedShowcasePosts   ShowcasePost[]        @relation("OwnedShowcasePosts")
  showcaseLikes        ShowcasePostLike[]    @relation("ShowcaseLikes")
  showcaseComments     ShowcasePostComment[] @relation("ShowcaseComments")

  // Resource Comments
  resourceComments     ResourceComment[] @relation("ResourceComments")

  // Resource Collections
  resourceCollections  UserResourceCollection[] @relation("UserCollections")

  // Notifications
  notifications Notification[] @relation("UserNotifications")

  @@index([email])
  @@index([username])
  @@index([status])
  @@map("user")
}

// ============================================
// BETTER AUTH MODELS
// ============================================

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// ============================================
// SOCIAL FEATURES
// ============================================

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model UserSocialLink {
  id        String         @id @default(cuid())
  userId    String
  type      SocialLinkType
  url       String
  label     String? // Optional custom label
  order     Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User @relation("UserSocialLinks", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
  @@map("user_social_links")
}

// ============================================
// TEAMS (Future feature - prepared)
// ============================================

model Team {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?  @db.Text
  logo        String?
  banner      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt


  // Ownership
  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  // Relations
  members       TeamMember[]
  invitations   TeamInvitation[]
  servers       Server[]
  resources     Resource[]
  socialLinks   TeamSocialLink[]  @relation("TeamSocialLinks")
  showcasePosts ShowcasePost[]    @relation("TeamShowcasePosts")

  @@index([ownerId])
  @@map("teams")
}

model TeamMember {
  id        String         @id @default(cuid())
  teamId    String
  userId    String
  role      TeamMemberRole @default(MEMBER)
  joinedAt  DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation("TeamMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model TeamInvitation {
  id        String               @id @default(cuid())
  teamId    String
  inviterId String // User who sent the invitation
  inviteeId String // User who receives the invitation
  role      TeamMemberRole       @default(MEMBER)
  status    TeamInvitationStatus @default(PENDING)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  expiresAt DateTime // Invitation expiration date

  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  inviter User @relation("TeamInvitationsSent", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User @relation("TeamInvitationsReceived", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([teamId, inviteeId, status]) // Prevent multiple pending invitations
  @@index([teamId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([status])
  @@index([expiresAt])
  @@map("team_invitations")
}

model TeamSocialLink {
  id        String         @id @default(cuid())
  teamId    String
  type      SocialLinkType
  url       String
  label     String? // Optional custom label
  order     Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  team Team @relation("TeamSocialLinks", fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, type])
  @@index([teamId])
  @@map("team_social_links")
}

// ============================================
// SERVER LISTING
// ============================================

model Server {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Basic Information
  name          String
  slug          String       @unique
  description   String       @db.Text
  shortDesc     String?      @db.VarChar(200)
  serverAddress String       // Format: "ip:port" or just "ip" (default port 5520)
  status        ServerStatus @default(PENDING)

  // Media
  logoUrl   String?
  bannerUrl String?

  // Game Information
  gameVersionId     String? // Primary game version
  gameVersion       HytaleVersion?           @relation("ServerGameVersion", fields: [gameVersionId], references: [id], onDelete: SetNull)
  supportedVersions ServerSupportedVersion[] // Supported game versions

  // Player Statistics
  currentPlayers Int       @default(0)
  maxPlayers     Int       @default(100)
  isOnline       Boolean   @default(false)
  lastPing       DateTime?

  playerHistory ServerPlayerHistory[]

  // Voting (Just counter for now, full system later)
  voteCount Int @default(0)

  // Links
  websiteUrl String?
  country    String?

  // Features
  featured Boolean @default(false)
  verified Boolean @default(false)

  // Moderation
  rejectionReason String?   @db.Text
  approvedAt      DateTime?
  approvedBy      String?
  approver        User?     @relation("ServerApprover", fields: [approvedBy], references: [id], onDelete: SetNull)

  // Ownership (Exclusive: either ownerUserId OR ownerTeamId, never both)
  ownerUserId String?
  ownerUser   User?   @relation("ServerOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  ownerTeamId String?
  ownerTeam   Team?   @relation(fields: [ownerTeamId], references: [id], onDelete: SetNull)

  // Relations
  tags              ServerTagRelation[]
  categories        ServerCategoryRelation[]
  statusHistory     ServerStatusHistory[]
  socialLinks       ServerSocialLink[]           @relation("ServerSocialLinks")
  descriptionImages ServerDescriptionImage[] // Inline images in description
  reports           Report[]                     @relation("ReportedServer")

  @@index([slug])
  @@index([status])
  @@index([ownerUserId])
  @@index([ownerTeamId])
  @@index([featured])
  @@index([voteCount])
  @@index([createdAt])
  @@index([isOnline])
  @@index([country])
  @@index([gameVersionId])
  @@map("servers")
}

// ============================================
// SERVER TAGS & CATEGORIES
// ============================================

model ServerTag {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String?  @default("#69a024")
  icon        String?
  usageCount  Int      @default(0) // Global usage count
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  servers ServerTagRelation[]

  @@index([usageCount])
  @@map("server_tags")
}

model ServerTagRelation {
  id       String @id @default(cuid())
  serverId String
  tagId    String

  server Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  tag    ServerTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([serverId, tagId])
  @@index([serverId])
  @@index([tagId])
  @@map("server_tag_relations")
}

model ServerCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?  @default("#69a024")
  order       Int      @default(0)
  usageCount  Int      @default(0) // Global usage count
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  servers ServerCategoryRelation[]

  @@index([usageCount])
  @@map("server_categories")
}

model ServerCategoryRelation {
  id         String  @id @default(cuid())
  serverId   String
  categoryId String
  isPrimary  Boolean @default(false) // One primary category per server

  server   Server         @relation(fields: [serverId], references: [id], onDelete: Cascade)
  category ServerCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([serverId, categoryId])
  @@index([serverId])
  @@index([categoryId])
  @@map("server_category_relations")
}

// ============================================
// SERVER STATUS & HISTORY
// ============================================

model ServerStatusHistory {
  id        String        @id @default(cuid())
  serverId  String
  oldStatus ServerStatus?
  newStatus ServerStatus
  reason    String?       @db.Text
  changedAt DateTime      @default(now())
  changedBy String?

  server  Server @relation(fields: [serverId], references: [id], onDelete: Cascade)
  changer User?  @relation("StatusChanger", fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([serverId])
  @@index([changedAt])
  @@map("server_status_history")
}

model ServerPlayerHistory {
  id        String   @id @default(cuid())
  serverId  String
  timestamp DateTime @default(now())

  currentPlayers Int
  isOnline       Boolean
  pingMs         Int?

  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([serverId, timestamp])
  @@index([timestamp])
  @@map("server_player_history")
}

model ServerSocialLink {
  id        String         @id @default(cuid())
  serverId  String
  type      SocialLinkType
  url       String
  label     String? // Optional custom label
  order     Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  server Server @relation("ServerSocialLinks", fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([serverId, type])
  @@index([serverId])
  @@map("server_social_links")
}

// Inline images in server description
model ServerDescriptionImage {
  id         String      @id @default(cuid())
  serverId   String? // NULL if temporary/draft
  url        String
  storageKey String // R2 key (temp/ or servers/)
  size       Int // Bytes
  hash       String // SHA256 hash for duplicate detection
  alt        String?
  status     ImageStatus @default(TEMPORARY)
  uploadedBy String
  uploadedAt DateTime    @default(now())
  expiresAt  DateTime? // For TEMPORARY images (24h)
  movedAt    DateTime? // When moved to PERMANENT

  server   Server? @relation(fields: [serverId], references: [id], onDelete: Cascade)
  uploader User    @relation("ServerDescriptionImages", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([serverId])
  @@index([status, expiresAt]) // For cleanup cron
  @@index([uploadedBy])
  @@index([status])
  @@index([uploadedBy, hash]) // For duplicate detection
  @@map("server_description_images")
}


// ============================================
// REPORT SYSTEM
// ============================================

model Report {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Report details
  resourceType ReportResourceType
  reason       ReportReason
  description  String?            @db.Text // Additional context if reason is OTHER
  status       ReportStatus       @default(PENDING)

  // Polymorphic relations (only one should be set based on resourceType)
  reportedUserId             String?
  reportedUser               User?                @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)

  reportedResourceId         String?
  reportedResource           Resource?            @relation("ReportedResource", fields: [reportedResourceId], references: [id], onDelete: Cascade)

  reportedResourceVersionId  String?
  reportedResourceVersion    ResourceVersion?     @relation("ReportedResourceVersion", fields: [reportedResourceVersionId], references: [id], onDelete: Cascade)

  reportedResourceCommentId  String?
  reportedResourceComment    ResourceComment?     @relation("ReportedResourceComment", fields: [reportedResourceCommentId], references: [id], onDelete: Cascade)

  reportedShowcasePostId     String?
  reportedShowcasePost       ShowcasePost?        @relation("ReportedShowcasePost", fields: [reportedShowcasePostId], references: [id], onDelete: Cascade)

  reportedShowcaseCommentId  String?
  reportedShowcaseComment    ShowcasePostComment? @relation("ReportedShowcaseComment", fields: [reportedShowcaseCommentId], references: [id], onDelete: Cascade)

  reportedServerId           String?
  reportedServer             Server?              @relation("ReportedServer", fields: [reportedServerId], references: [id], onDelete: Cascade)

  // Reporter
  reporterId String
  reporter   User   @relation("ReportSubmitter", fields: [reporterId], references: [id], onDelete: Cascade)

  // Moderation
  handledBy String?
  handler   User?     @relation("ReportHandler", fields: [handledBy], references: [id], onDelete: SetNull)
  handledAt DateTime?
  response  String?   @db.Text // Moderator's response or notes

  @@index([resourceType])
  @@index([reportedUserId])
  @@index([reportedResourceId])
  @@index([reportedResourceVersionId])
  @@index([reportedResourceCommentId])
  @@index([reportedShowcasePostId])
  @@index([reportedShowcaseCommentId])
  @@index([reportedServerId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
  @@map("reports")
}

// ============================================
// BADGE SYSTEM
// ============================================

model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?  @db.Text
  icon        String? // URL or icon identifier
  color       String?  @default("#69a024")
  rarity      String   @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userBadges UserBadge[]

  @@index([slug])
  @@index([isActive])
  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  awardedBy String? // ID of admin who awarded it, null if automatic
  reason    String?  @db.Text // Optional reason for manual awards

  user  User  @relation("UserBadges", fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([awardedAt])
  @@map("user_badges")
}

// ============================================================================
// MARKETPLACE - RESOURCES
// ============================================================================

model Resource {
  id String @id @default(cuid())

  // Basic Info
  name        String
  slug        String             @unique
  tagline     String             @db.VarChar(200) // Short description
  description String?            @db.Text // Full description (Markdown/HTML with images)
  type        ResourceType
  status      ResourceStatus     @default(DRAFT)

  // Media
  iconUrl           String?
  bannerUrl         String?
  galleryImages     ResourceGalleryImage[] // Screenshots/gallery
  descriptionImages ResourceDescriptionImage[] // Inline images in description

  // Versioning
  versions        ResourceVersion[]
  latestVersionId String?
  latestVersion   ResourceVersion?  @relation("LatestVersion", fields: [latestVersionId], references: [id], onDelete: SetNull)

  // Organization
  categories ResourceToCategory[]
  tags       ResourceToTag[]

  // Pricing
  priceType PriceType @default(FREE)
  price     Decimal?  @db.Decimal(10, 2)
  currency  String?   @default("USD")

  // Licensing
  licenseType       LicenseType
  customLicenseName String? // If CUSTOM
  licenseSpdxId     String? // Optional SPDX identifier
  licenseUrl        String? // Required if CUSTOM

  // External Links
  externalLinks ResourceExternalLink[]

  // Stats
  likeCount     Int @default(0)
  favoriteCount Int @default(0)
  downloadCount Int @default(0)
  viewCount     Int @default(0)

  // Features
  featured  Boolean @default(false)
  verified  Boolean @default(false)
  staffPick Boolean @default(false)

  // Ownership (Exclusive: either ownerUserId OR ownerTeamId, never both)
  ownerUserId  String?
  ownerUser    User?                 @relation("OwnedResources", fields: [ownerUserId], references: [id], onDelete: Cascade)
  ownerTeamId  String?
  ownerTeam    Team?                 @relation(fields: [ownerTeamId], references: [id], onDelete: SetNull)
  contributors ResourceContributor[]

  // Relations
  likes         ResourceLike[]
  favorites     ResourceFavorite[]
  downloads     ResourceDownload[]
  statusHistory ResourceStatusHistory[]
  usedBy        ResourceVersionDependency[] @relation("ResourceDependencies")

  // Discovery - Resource Collections
  discoveryResourceCollections DiscoveryResourceCollectionItem[]

  // Showcase - Linked posts
  linkedShowcases ShowcasePost[] @relation("LinkedShowcase")

  // User Collections
  collectionItems UserResourceCollectionItem[]

  // Comments
  comments      ResourceComment[]
  commentCount  Int @default(0)

  // Reports
  reports       Report[] @relation("ReportedResource")

  // Moderation
  moderationNotes String? // Internal staff notes
  rejectionReason String? // If status = REJECTED
  moderatedById   String?
  moderatedBy     User?     @relation("ModeratedResources", fields: [moderatedById], references: [id], onDelete: SetNull)
  moderatedAt     DateTime?

  // Timestamps
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  publishedAt    DateTime?
  lastActivityAt DateTime  @default(now()) // Last update/version
  deletedAt      DateTime? // Soft delete

  @@index([ownerUserId])
  @@index([ownerTeamId])
  @@index([type])
  @@index([status])
  @@index([featured])
  @@index([publishedAt])
  @@index([lastActivityAt])
  @@index([slug])
  @@map("resources")
}

// ============================================================================
// RESOURCE ENUMS
// ============================================================================

enum ResourceType {
  PLUGIN
  ASSET_PACK
  MOD
  MODPACK
  PREMADE_SERVER
  WORLD
  PREFAB
  DATA_PACK
  TOOLS_SCRIPTS
}

enum ResourceStatus {
  DRAFT // Being created
  PENDING // Awaiting moderation
  APPROVED // Published
  REJECTED // Rejected by moderation
  SUSPENDED // Suspended (violation)
  ARCHIVED // Archived by owner
  DELETED // Soft deleted
}

enum PriceType {
  FREE
  PAID
  DONATION
}

enum LicenseType {
  // Common open source
  MIT
  APACHE_2_0
  GPL_3_0
  LGPL_3_0
  BSD_3_CLAUSE
  BSD_2_CLAUSE
  MPL_2_0

  // Creative Commons
  CC_BY_4_0
  CC_BY_SA_4_0
  CC_BY_NC_4_0
  CC_BY_NC_SA_4_0
  CC_BY_ND_4_0
  CC_BY_NC_ND_4_0
  CC0_1_0

  // Restrictive
  ALL_RIGHTS_RESERVED

  // Custom
  CUSTOM
}

// ============================================================================
// RESOURCE MEDIA
// ============================================================================

// Gallery images (screenshots, banners, etc.)
model ResourceGalleryImage {
  id         String  @id @default(cuid())
  resourceId String
  url        String
  storageKey String
  caption    String?
  order      Int     @default(0)
  size       Int // Bytes

  title       String?
  description String? @db.Text

  createdAt DateTime @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([order])
  @@map("resource_gallery_images")
}

// Inline images in resource description
model ResourceDescriptionImage {
  id         String      @id @default(cuid())
  resourceId String? // NULL if temporary/draft
  url        String
  storageKey String // R2 key (temp/ or resources/)
  size       Int // Bytes
  hash       String // SHA256 hash for duplicate detection
  alt        String?
  status     ImageStatus @default(TEMPORARY)
  uploadedBy String
  uploadedAt DateTime    @default(now())
  expiresAt  DateTime? // For TEMPORARY images (24h)
  movedAt    DateTime? // When moved to PERMANENT

  resource Resource? @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  uploader User      @relation("ResourceDescriptionImages", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([status, expiresAt]) // For cleanup cron
  @@index([uploadedBy])
  @@index([status])
  @@index([uploadedBy, hash]) // For duplicate detection
  @@map("resource_description_images")
}

enum ImageStatus {
  TEMPORARY // Cache, will be deleted if not used
  PERMANENT // Used in a published resource/version
  ORPHANED // Detected as unused
}

// ============================================================================
// EXTERNAL LINKS
// ============================================================================

model ResourceExternalLink {
  id         String           @id @default(cuid())
  resourceId String
  type       ExternalLinkType
  url        String
  label      String? // Optional custom label
  order      Int              @default(0)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, type])
  @@index([resourceId])
  @@index([order])
  @@map("resource_external_links")
}

enum ExternalLinkType {
  ISSUE_TRACKER
  SOURCE_CODE
  WIKI
  DISCORD
  DONATION
  WEBSITE
  OTHER
}

// ============================================================================
// RESOURCE CATEGORIES
// ============================================================================

model ResourceCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String? // Icon name or emoji
  color       String? // Hex color for UI
  order       Int     @default(0)
  usageCount  Int     @default(0) // Global usage count

  // Resource types this category applies to (empty = all types)
  resourceTypes ResourceType[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resources   ResourceToCategory[]
  usageByType ResourceCategoryUsageByType[] // Usage statistics per resource type

  @@index([order])
  @@index([usageCount])
  @@map("resource_categories")
}

model ResourceToCategory {
  resourceId String
  categoryId String
  addedAt    DateTime @default(now())

  resource Resource         @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  category ResourceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([resourceId, categoryId])
  @@index([categoryId])
  @@map("resource_to_categories")
}

// Track category usage per resource type for analytics and filtering
model ResourceCategoryUsageByType {
  id           String       @id @default(cuid())
  categoryId   String
  resourceType ResourceType
  usageCount   Int          @default(0)

  category ResourceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, resourceType])
  @@index([categoryId])
  @@index([resourceType])
  @@index([usageCount])
  @@map("resource_category_usage_by_type")
}

// ============================================================================
// RESOURCE TAGS
// ============================================================================

model ResourceTag {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String? // Optional: emoji or icon name
  color       String? // Hex color for UI
  usageCount  Int      @default(0) // Global usage count
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  resources   ResourceToTag[]
  usageByType ResourceTagUsageByType[] // Usage statistics per resource type

  @@index([usageCount])
  @@map("resource_tags")
}

model ResourceToTag {
  resourceId String
  tagId      String
  addedAt    DateTime @default(now())

  resource Resource    @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  tag      ResourceTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([resourceId, tagId])
  @@index([tagId])
  @@map("resource_to_tags")
}

// Track tag usage per resource type for analytics and recommendations
model ResourceTagUsageByType {
  id           String       @id @default(cuid())
  tagId        String
  resourceType ResourceType
  usageCount   Int          @default(0)

  tag ResourceTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, resourceType])
  @@index([tagId])
  @@index([resourceType])
  @@index([usageCount])
  @@map("resource_tag_usage_by_type")
}

// ============================================================================
// VERSIONS
// ============================================================================

model ResourceVersion {
  id         String @id @default(cuid())
  resourceId String

  // Version Info
  versionNumber String // "1.2.3"
  name          String? // "The Big Update"
  channel       ReleaseChannel @default(RELEASE)

  // Compatibility
  compatibleVersions ResourceVersionToHytaleVersion[]

  // Changelog
  changelog String? @db.Text

  // Files (multiple files per version with primary)
  files         ResourceVersionFile[]
  // Primary file for download
  primaryFileId String? // The main download file
  primaryFile   ResourceVersionFile?  @relation("PrimaryFile", fields: [primaryFileId], references: [id], onDelete: SetNull)

  // Status
  status VersionStatus @default(DRAFT)
  rejectionReason String? @db.Text // Reason for rejection by moderator

  // Images in changelog
  changelogImages ResourceVersionChangelogImage[]

  // Publication
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  resource          Resource                    @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  latestFor         Resource[]                  @relation("LatestVersion")
  dependencies      ResourceVersionDependency[]
  commentsAtVersion ResourceComment[]           @relation("CommentAtVersion")
  downloadCount     Int                         @default(0)
  reports           Report[]                    @relation("ReportedResourceVersion")

  @@unique([resourceId, versionNumber])
  @@index([resourceId, channel])
  @@index([publishedAt])
  @@index([resourceId, status])
  @@map("resource_versions")
}

// ============================================================================
// HYTALE VERSIONS
// ============================================================================

model HytaleVersion {
  id            String   @id @default(cuid())
  hytaleVersion String   @unique // "1.0", "1.1", etc.
  name          String? // Optional display name
  releaseDate   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  resourceVersions       ResourceVersionToHytaleVersion[]
  servers                Server[]                        @relation("ServerGameVersion")
  supportedByServers     ServerSupportedVersion[]

  @@index([hytaleVersion])
  @@map("hytale_versions")
}

// Junction table for ResourceVersion to HytaleVersion compatibility
model ResourceVersionToHytaleVersion {
  id                String   @id @default(cuid())
  resourceVersionId String
  hytaleVersionId   String
  addedAt           DateTime @default(now())

  resourceVersion ResourceVersion @relation(fields: [resourceVersionId], references: [id], onDelete: Cascade)
  hytaleVersion   HytaleVersion   @relation(fields: [hytaleVersionId], references: [id], onDelete: Cascade)

  @@unique([resourceVersionId, hytaleVersionId])
  @@index([resourceVersionId])
  @@index([hytaleVersionId])
  @@map("resource_version_to_hytale_versions")
}

// Join table for Server supported versions
model ServerSupportedVersion {
  id              String   @id @default(cuid())
  serverId        String
  hytaleVersionId String
  addedAt         DateTime @default(now())

  server        Server        @relation(fields: [serverId], references: [id], onDelete: Cascade)
  hytaleVersion HytaleVersion @relation(fields: [hytaleVersionId], references: [id], onDelete: Cascade)

  @@unique([serverId, hytaleVersionId])
  @@index([serverId])
  @@index([hytaleVersionId])
  @@map("server_supported_versions")
}

enum ReleaseChannel {
  RELEASE // Stable, production-ready
  BETA // Feature complete, testing phase
  ALPHA // Early access, unstable
  SNAPSHOT // Development builds
}

enum VersionStatus {
  DRAFT
  PENDING // Awaiting moderation
  APPROVED
  REJECTED
  ARCHIVED // Old version, no longer recommended
}

// Inline images in version changelog
model ResourceVersionChangelogImage {
  id         String      @id @default(cuid())
  versionId  String? // NULL if temporary/draft
  url        String
  storageKey String // R2 key (temp/ or versions/)
  size       Int // Bytes
  hash       String // SHA256 hash for duplicate detection
  alt        String?
  status     ImageStatus @default(TEMPORARY)
  uploadedBy String
  uploadedAt DateTime    @default(now())
  expiresAt  DateTime? // For TEMPORARY images (24h)
  movedAt    DateTime? // When moved to PERMANENT

  version  ResourceVersion? @relation(fields: [versionId], references: [id], onDelete: Cascade)
  uploader User             @relation("VersionChangelogImages", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([status, expiresAt]) // For cleanup cron
  @@index([uploadedBy])
  @@index([status])
  @@index([uploadedBy, hash]) // For duplicate detection
  @@map("resource_version_changelog_images")
}

// ============================================================================
// VERSION FILES
// ============================================================================

model ResourceVersionFile {
  id        String @id @default(cuid())
  versionId String

  // File Info
  filename    String
  displayName String? // Display name (optional)
  fileType    FileType

  // Storage
  storageKey String // R2 key
  url        String // Download URL
  size       Int // Bytes
  hash       String // SHA256 for verification

  // Metadata
  uploadedAt DateTime @default(now())

  // Relations
  version    ResourceVersion   @relation(fields: [versionId], references: [id], onDelete: Cascade)
  primaryFor ResourceVersion[] @relation("PrimaryFile")

  @@index([versionId])
  @@map("resource_version_files")
}

enum FileType {
  JAR // Plugin/Mod
  ZIP // Asset pack, world, etc.
  SCHEMATIC // Prefab
  JSON // Data pack
  OTHER
}

// Dependencies between versions
model ResourceVersionDependency {
  id                 String         @id @default(cuid())
  versionId          String
  dependencyId       String // ID of the dependent resource
  dependencyType     DependencyType
  versionRequirement String? // ">=1.0.0", "^2.1.0", etc.

  version    ResourceVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  dependency Resource        @relation("ResourceDependencies", fields: [dependencyId], references: [id], onDelete: Cascade)

  @@unique([versionId, dependencyId])
  @@index([dependencyId])
  @@map("resource_version_dependencies")
}

enum DependencyType {
  REQUIRED // Required
  OPTIONAL // Optional but recommended
  INCOMPATIBLE // Doesn't work with
}

// ============================================================================
// CONTRIBUTORS
// ============================================================================

model ResourceContributor {
  id         String   @id @default(cuid())
  resourceId String
  userId     String
  role       String // "Developer", "Artist", "Tester"
  addedAt    DateTime @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([resourceId, userId])
  @@index([userId])
  @@map("resource_contributors")
}

// ============================================================================
// LIKES & FAVORITES
// ============================================================================

model ResourceLike {
  id         String   @id @default(cuid())
  userId     String
  resourceId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
  @@map("resource_likes")
}

model ResourceFavorite {
  id         String   @id @default(cuid())
  userId     String
  resourceId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
  @@map("resource_favorites")
}

// ============================================================================
// USER RESOURCE COLLECTIONS
// ============================================================================

model UserResourceCollection {
  id          String   @id @default(cuid())
  userId      String
  name        String   @db.VarChar(100)
  description String?  @db.VarChar(300)
  isDefault   Boolean  @default(false) // Only one default per user
  isPublic    Boolean  @default(false) // Public collections visible on profile
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User                          @relation("UserCollections", fields: [userId], references: [id], onDelete: Cascade)
  items UserResourceCollectionItem[]

  @@unique([userId, name]) // Each user can have unique collection names
  @@index([userId])
  @@index([userId, isDefault])
  @@index([userId, isPublic])
  @@map("user_resource_collections")
}

model UserResourceCollectionItem {
  id           String   @id @default(cuid())
  collectionId String
  resourceId   String
  addedAt      DateTime @default(now())

  collection UserResourceCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  resource   Resource               @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([collectionId, resourceId]) // Prevent duplicates
  @@index([collectionId])
  @@index([resourceId])
  @@map("user_resource_collection_items")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  data      Json?            // Additional data (resource ID, user ID, etc.)
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  
  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// DOWNLOADS
// ============================================================================

model ResourceDownload {
  id           String   @id @default(cuid())
  resourceId   String
  versionId    String?
  userId       String? // Null if anonymous
  ipAddress    String? // For analytics
  userAgent    String?
  downloadedAt DateTime @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([resourceId])
  @@index([userId])
  @@index([downloadedAt])
  @@map("resource_downloads")
}

// ============================================================================
// STATUS HISTORY
// ============================================================================

model ResourceStatusHistory {
  id          String         @id @default(cuid())
  resourceId  String
  fromStatus  ResourceStatus
  toStatus    ResourceStatus
  reason      String?
  changedById String
  changedBy   User           @relation(fields: [changedById], references: [id], onDelete: Cascade)
  changedAt   DateTime       @default(now())

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([changedAt])
  @@map("resource_status_history")
}

model Apikey {
  id                  String    @id
  name                String?
  start               String?
  prefix              String?
  key                 String
  userId              String
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refillInterval      Int?
  refillAmount        Int?
  lastRefillAt        DateTime?
  enabled             Boolean?  @default(true)
  rateLimitEnabled    Boolean?  @default(true)
  rateLimitTimeWindow Int?      @default(86400000)
  rateLimitMax        Int?      @default(10)
  requestCount        Int?      @default(0)
  remaining           Int?
  lastRequest         DateTime?
  expiresAt           DateTime?
  createdAt           DateTime
  updatedAt           DateTime
  permissions         String?
  metadata            String?

  @@index([key])
  @@index([userId])
  @@map("apikey")
}

// ============================================
// DISCOVERY RESOURCE COLLECTIONS
// ============================================

model DiscoveryResourceCollection {
  id          String                         @id @default(cuid())
  type        DiscoveryResourceCollectionType @unique
  title       String                         // e.g., "Selection of the Week", "Medieval Era"
  description String?                        @db.Text
  metadata    Json?                          // For theme info, dates, background image URL, etc.
  isActive    Boolean                        @default(true)
  createdAt   DateTime                       @default(now())
  updatedAt   DateTime                       @updatedAt

  items DiscoveryResourceCollectionItem[]

  @@map("discovery_resource_collections")
}

model DiscoveryResourceCollectionItem {
  id           String                      @id @default(cuid())
  collectionId String
  resourceId   String
  order        Int                         @default(0)
  startDate    DateTime                    @default(now())  // When it becomes active
  endDate      DateTime?                   // When it ends (null = current)
  addedAt      DateTime                    @default(now())

  collection DiscoveryResourceCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  resource   Resource                    @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([collectionId, resourceId])
  @@index([collectionId, order])
  @@index([collectionId, endDate])  // Critical for performance when querying current items
  @@map("discovery_resource_collection_items")
}

// ============================================
// SHOWCASE SYSTEM
// ============================================

model ShowcasePost {
  id          String   @id @default(cuid())
  title       String   @db.VarChar(200)
  description String?  @db.Text
  category    ShowcaseCategory
  status      ShowcasePostStatus @default(DRAFT)
  
  // Media
  media        ShowcasePostMedia[]
  thumbnailUrl String? // Primary thumbnail
  
  // Stats
  likeCount    Int @default(0)
  commentCount Int @default(0)
  viewCount    Int @default(0)
  
  // Featured
  featured Boolean @default(false)
  
  // Ownership
  authorId     String  // User who created the post
  author       User    @relation("ShowcasePosts", fields: [authorId], references: [id], onDelete: Cascade)
  ownerUserId  String? // Owner if user (exclusive with ownerTeamId)
  ownerUser    User?   @relation("OwnedShowcasePosts", fields: [ownerUserId], references: [id], onDelete: Cascade)
  ownerTeamId  String? // Owner if team (exclusive with ownerUserId)
  ownerTeam    Team?   @relation("TeamShowcasePosts", fields: [ownerTeamId], references: [id], onDelete: SetNull)
  
  // Relations
  likes    ShowcasePostLike[]
  comments ShowcasePostComment[]
  
  // Optional link to published resource
  linkedResourceId String?
  linkedResource   Resource? @relation("LinkedShowcase", fields: [linkedResourceId], references: [id], onDelete: SetNull)

  // Reports
  reports Report[] @relation("ReportedShowcasePost")
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([authorId])
  @@index([ownerUserId])
  @@index([ownerTeamId])
  @@index([category])
  @@index([status])
  @@index([featured])
  @@index([createdAt])
  @@map("showcase_posts")
}

model ShowcasePostMedia {
  id         String            @id @default(cuid())
  postId     String
  url        String
  storageKey String
  type       ShowcaseMediaType @default(IMAGE)
  order      Int               @default(0)
  caption    String?
  size       Int?              // Bytes
  
  createdAt DateTime @default(now())
  
  post ShowcasePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@index([postId, order])
  @@map("showcase_post_media")
}

model ShowcasePostLike {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime @default(now())
  
  user User         @relation("ShowcaseLikes", fields: [userId], references: [id], onDelete: Cascade)
  post ShowcasePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("showcase_post_likes")
}

model ShowcasePostComment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  userId    String
  postId    String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user    User                  @relation("ShowcaseComments", fields: [userId], references: [id], onDelete: Cascade)
  post    ShowcasePost          @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent  ShowcasePostComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies ShowcasePostComment[] @relation("CommentReplies")
  reports Report[]              @relation("ReportedShowcaseComment")
  
  @@index([postId, createdAt])
  @@index([userId])
  @@index([parentId])
  @@map("showcase_post_comments")
}

// ============================================
// RESOURCE COMMENTS
// ============================================

model ResourceComment {
  id         String   @id @default(cuid())
  content    String   @db.Text
  userId     String
  resourceId String
  versionId  String?  // The version at time of comment (only for main comments, NULL for replies)
  parentId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User               @relation("ResourceComments", fields: [userId], references: [id], onDelete: Cascade)
  resource Resource           @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  version  ResourceVersion?   @relation("CommentAtVersion", fields: [versionId], references: [id], onDelete: SetNull)
  parent   ResourceComment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  ResourceComment[]  @relation("CommentReplies")
  reports  Report[]           @relation("ReportedResourceComment")

  @@index([resourceId, createdAt])
  @@index([userId])
  @@index([parentId])
  @@map("resource_comments")
}
